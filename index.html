<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Device Security Verification</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 450px;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 30px;
        }
        
        .step {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .step.active {
            display: block;
        }
        
        .step-icon {
            font-size: 48px;
            text-align: center;
            margin-bottom: 20px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .step-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: center;
            color: #333;
        }
        
        .step-desc {
            color: #666;
            text-align: center;
            margin-bottom: 25px;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .device-info {
            background: #f8fafc;
            border-radius: 12px;
            padding: 15px;
            margin: 20px 0;
            border: 1px solid #e2e8f0;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            color: #64748b;
            font-size: 14px;
        }
        
        .info-value {
            color: #334155;
            font-weight: 500;
            font-size: 14px;
        }
        
        .btn {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
        }
        
        .btn-secondary:hover {
            background: #e2e8f0;
            box-shadow: 0 10px 25px rgba(148, 163, 184, 0.3);
        }
        
        .progress-bar {
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .success-animation {
            color: #10b981;
            font-size: 60px;
            text-align: center;
            animation: scaleIn 0.5s ease;
        }
        
        .error-animation {
            color: #ef4444;
            font-size: 60px;
            text-align: center;
            animation: shake 0.5s ease;
        }
        
        .warning-animation {
            color: #f59e0b;
            font-size: 60px;
            text-align: center;
            animation: pulse 1s infinite;
        }
        
        .countdown {
            color: #7c3aed;
            font-weight: bold;
            font-size: 18px;
        }
        
        .connection-test {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 8px;
            padding: 10px;
            margin: 15px 0;
            text-align: center;
            font-size: 13px;
            color: #92400e;
        }
        
        .test-result {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: bold;
        }
        
        .test-success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .test-failed {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
            color: #94a3b8;
            font-size: 12px;
        }
        
        .telegram-badge {
            display: inline-flex;
            align-items: center;
            background: #0088cc;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            margin-top: 10px;
            text-decoration: none;
            font-weight: 500;
        }
        
        .telegram-badge:hover {
            background: #0077b5;
        }
        
        .telegram-badge i {
            margin-right: 8px;
            font-size: 18px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes scaleIn {
            0% { transform: scale(0); }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Security Verification</h1>
            <p>Verify your device to continue using the service</p>
        </div>
        
        <div class="progress-bar">
            <div class="progress" id="progress"></div>
        </div>
        
        <div class="content">
            <!-- Step 1: Initialization -->
            <div class="step active" id="step1">
                <div class="step-icon">üåê</div>
                <div class="step-title">Checking Connection</div>
                <div class="step-desc">Testing internet connection and server availability...</div>
                <div class="connection-test">
                    Internet Connection: <span id="internetStatus" class="test-result">Testing...</span>
                </div>
            </div>
            
            <!-- Step 2: Device Information -->
            <div class="step" id="step2">
                <div class="step-icon">üì±</div>
                <div class="step-title">Checking Environment</div>
                <div class="step-desc">Verifying Telegram environment and device information...</div>
                <div class="connection-test">
                    Telegram WebView: <span id="telegramStatus" class="test-result">Checking...</span>
                </div>
            </div>
            
            <!-- Step 3: Device Information Display -->
            <div class="step" id="step3">
                <div class="step-icon">üîç</div>
                <div class="step-title">Device Information</div>
                <div class="step-desc">Generating unique device identifier...</div>
                
                <div class="device-info">
                    <div class="info-row">
                        <span class="info-label">Device Type:</span>
                        <span class="info-value" id="deviceType">Detecting...</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Platform:</span>
                        <span class="info-value" id="platform">Detecting...</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Device ID:</span>
                        <span class="info-value" id="deviceId">Generating...</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Connection:</span>
                        <span class="info-value" id="connectionStatus">Checking...</span>
                    </div>
                </div>
                
                <button class="btn" onclick="nextStep()">Start Verification</button>
            </div>
            
            <!-- Step 4: Verifying -->
            <div class="step" id="step4">
                <div class="step-icon">
                    <i class="fas fa-spinner fa-spin" style="color: #7c3aed; font-size: 48px;"></i>
                </div>
                <div class="step-title">Verifying Device</div>
                <div class="step-desc">Please wait while we verify your device...</div>
                <div class="step-desc" id="statusText">Connecting to verification server...</div>
            </div>
            
            <!-- Step 5: Success -->
            <div class="step" id="step5">
                <div class="success-animation">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="step-title">Verification Successful!</div>
                <div class="step-desc">Your device has been verified.</div>
                <div class="step-desc">
                    You can now close this window and return to Telegram.
                </div>
                <button class="btn" onclick="closeWebView()">
                    <i class="fas fa-paper-plane"></i> Return to Telegram
                </button>
            </div>
            
            <!-- Step 6: Internet Failed -->
            <div class="step" id="step6">
                <div class="step-icon">‚úñÔ∏è</div>
                <div class="step-title">Connection Failed</div>
                <div class="step-desc" id="errorMessage">Internet connection failed. Please check your connection and try again later.</div>
                <div class="step-desc">
                    Error: Internet offline or server unreachable
                </div>
                <button class="btn" onclick="closeWebView()">
                    <i class="fas fa-times"></i> Close Window
                </button>
            </div>
            
            <!-- Step 7: Data Issue -->
            <div class="step" id="step7">
                <div class="step-icon">‚ö†Ô∏è</div>
                <div class="step-title">Data Issue Detected</div>
                <div class="step-desc" id="dataIssueMessage">There was a problem with the verification data.</div>
                <div class="step-desc">
                    Please contact support for assistance.
                </div>
                <button class="btn" onclick="closeWebView()">
                    <i class="fas fa-times"></i> Close Window
                </button>
                <button class="btn btn-secondary" onclick="contactSupport()">
                    <i class="fas fa-headset"></i> Contact Support
                </button>
            </div>
            
            <!-- Step 8: VPN Detected -->
            <div class="step" id="step8">
                <div class="step-icon">üö´</div>
                <div class="step-title">VPN Detected</div>
                <div class="step-desc">VPN usage is not allowed for security reasons.</div>
                <div class="step-desc">
                    Please disable your VPN and try again.
                </div>
                <button class="btn" onclick="closeWebView()">
                    <i class="fas fa-times"></i> Close Window
                </button>
            </div>
            
            <!-- Step 9: Already Verified -->
            <div class="step" id="step9">
                <div class="step-icon">‚è≥</div>
                <div class="step-title">Already Verified</div>
                <div class="step-desc">This device has already been verified.</div>
                <div class="step-desc">
                    You can continue using the bot.
                </div>
                <button class="btn" onclick="closeWebView()">
                    <i class="fas fa-paper-plane"></i> Return to Telegram
                </button>
            </div>
        </div>
        
        <div class="footer">
            <p>Developed by #TXG</p>
            <a href="https://t.me/TXG_MAKER_bot?start=5478832701" class="telegram-badge" target="_blank">
                <i class="fab fa-telegram"></i> Contact Technical Support
            </a>
        </div>
    </div>

    <script>
        // Global variables
        let currentStep = 1;
        let deviceHash = '';
        let webhookUrl = '';
        let botId = '';
        
        // Execute after page loads
        document.addEventListener('DOMContentLoaded', async function() {
            // Get parameters from URL
            const urlParams = new URLSearchParams(window.location.search);
            webhookUrl = urlParams.get('webhookUrl');
            botId = urlParams.get('botid') || 'default';
            
            // Start verification process
            await checkConnectionAndStart();
        });
        
        // Check internet connection
        async function checkInternetConnection() {
            try {
                // Test connection with timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch('https://www.google.com/favicon.ico', {
                    method: 'HEAD',
                    cache: 'no-cache',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                return response.ok;
            } catch (error) {
                return false;
            }
        }
        
        // Check connection and start verification
        async function checkConnectionAndStart() {
            updateProgress(10);
            
            // Check internet connection
            const hasInternet = await checkInternetConnection();
            document.getElementById('internetStatus').textContent = hasInternet ? '‚úì Connected' : '‚úñÔ∏è Failed';
            document.getElementById('internetStatus').className = hasInternet ? 'test-result test-success' : 'test-result test-failed';
            
            if (!hasInternet) {
                setTimeout(() => {
                    showInternetFailure();
                }, 1500);
                return;
            }
            
            updateProgress(30);
            
            // Check Telegram environment
            const isTelegram = checkTelegramEnvironment();
            document.getElementById('telegramStatus').textContent = isTelegram ? '‚úì Detected' : '‚úñÔ∏è Not Found';
            document.getElementById('telegramStatus').className = isTelegram ? 'test-result test-success' : 'test-result test-failed';
            
            if (!isTelegram) {
                setTimeout(() => {
                    showError('Please open this page in Telegram');
                }, 1500);
                return;
            }
            
            updateProgress(50);
            
            // Continue to device detection
            await initializeVerification();
        }
        
        // Initialize verification
        async function initializeVerification() {
            try {
                // Get device information
                const deviceInfo = await getDeviceInfo();
                document.getElementById('deviceType').textContent = deviceInfo.isMobile ? 'Mobile Device' : 'Computer';
                document.getElementById('platform').textContent = deviceInfo.platform;
                document.getElementById('connectionStatus').textContent = '‚úì Online';
                
                // Generate device ID
                deviceHash = await generateDeviceHash(deviceInfo);
                document.getElementById('deviceId').textContent = 
                    deviceHash.substring(0, 8) + '...' + deviceHash.substring(deviceHash.length - 8);
                
                updateProgress(70);
                
                // Go to step 3
                setTimeout(() => {
                    nextStep();
                }, 1000);
                
            } catch (error) {
                console.error('Initialization failed:', error);
                showDataIssue('Device detection failed');
            }
        }
        
        // Check Telegram environment
        function checkTelegramEnvironment() {
            const ua = navigator.userAgent.toLowerCase();
            const isTelegram = ua.includes('telegram') || ua.includes('webview');
            
            const hasWebApp = window.Telegram && Telegram.WebApp;
            
            return isTelegram || hasWebApp;
        }
        
        // Get device information
        async function getDeviceInfo() {
            const ua = navigator.userAgent;
            const isMobile = /Android|iPhone|iPad|iPod|Mobile/i.test(ua);
            
            return {
                userAgent: ua,
                platform: navigator.platform,
                language: navigator.language,
                screen: `${screen.width}x${screen.height}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                isMobile: isMobile,
                timestamp: Date.now()
            };
        }
        
        // Generate device hash
        async function generateDeviceHash(deviceInfo) {
            const dataString = JSON.stringify({
                ...deviceInfo,
                botId: botId,
                salt: 'txg_device_verify_2024'
            });
            
            const encoder = new TextEncoder();
            const data = encoder.encode(dataString);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        // Perform verification
        async function performVerification() {
            updateProgress(80);
            document.getElementById('statusText').textContent = 'Connecting to verification server...';
            
            try {
                // Check internet before making request
                const hasInternet = await checkInternetConnection();
                if (!hasInternet) {
                    throw new Error('No internet connection');
                }
                
                // Prepare verification data
                const verificationData = {
                    deviceId: deviceHash,
                    botId: botId,
                    timestamp: Date.now(),
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    telegramData: window.Telegram?.WebApp?.initDataUnsafe || {}
                };
                
                // Call our API
                document.getElementById('statusText').textContent = 'Saving verification record...';
                
                const apiResponse = await fetchWithTimeout('/api/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ...verificationData,
                        action: 'device_verification'
                    })
                }, 10000);
                
                if (!apiResponse.ok) {
                    throw new Error('Verification server error');
                }
                
                updateProgress(90);
                document.getElementById('statusText').textContent = 'Calling callback webhook...';
                
                // Call webhook
                const webhookResponse = await fetchWithTimeout(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        deviceId: deviceHash,
                        botId: botId,
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent
                    })
                }, 15000);
                
                updateProgress(100);
                
                if (!webhookResponse.ok) {
                    throw new Error('Webhook callback failed');
                }
                
                // Parse response
                const responseData = await webhookResponse.json();
                
                // Check response format
                if (!responseData || !responseData.results) {
                    throw new Error('Invalid response format');
                }
                
                const { user_hash, captcha, vpn, Dataissu } = responseData.results;
                
                // Check Dataissu field
                if (Dataissu === "yes") {
                    showDataIssue('Data validation failed');
                    return;
                }
                
                // Check VPN
                if (vpn === "yes") {
                    showVPNBlocked();
                    return;
                }
                
                // Check verification result
                if (captcha === "ok") {
                    if (user_hash === deviceHash) {
                        showSuccess();
                    } else {
                        showAlreadyVerified();
                    }
                } else {
                    showError('Verification failed');
                }
                
            } catch (error) {
                console.error('Verification process error:', error);
                
                if (error.message.includes('timeout') || error.message.includes('network') || !navigator.onLine) {
                    showInternetFailure();
                } else if (error.message.includes('Invalid response') || error.message.includes('format')) {
                    showDataIssue('Invalid server response');
                } else {
                    showError('Verification failed');
                }
            }
        }
        
        // Fetch with timeout
        async function fetchWithTimeout(url, options, timeout = 10000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                throw error;
            }
        }
        
        // Show success
        function showSuccess() {
            currentStep = 5;
            updateSteps();
        }
        
        // Show internet failure
        function showInternetFailure() {
            currentStep = 6;
            updateSteps();
        }
        
        // Show data issue
        function showDataIssue(message) {
            currentStep = 7;
            updateSteps();
            document.getElementById('dataIssueMessage').textContent = message;
        }
        
        // Show VPN blocked
        function showVPNBlocked() {
            currentStep = 8;
            updateSteps();
        }
        
        // Show already verified
        function showAlreadyVerified() {
            currentStep = 9;
            updateSteps();
        }
        
        // Show error
        function showError(message) {
            currentStep = 6;
            updateSteps();
            document.getElementById('errorMessage').textContent = message;
        }
        
        // Next step
        function nextStep() {
            currentStep++;
            
            if (currentStep === 4) {
                updateSteps();
                performVerification();
            } else {
                updateSteps();
            }
            
            updateProgress(currentStep * 20);
        }
        
        // Update step display
        function updateSteps() {
            for (let i = 1; i <= 9; i++) {
                document.getElementById(`step${i}`).classList.remove('active');
            }
            document.getElementById(`step${currentStep}`).classList.add('active');
        }
        
        // Update progress bar
        function updateProgress(percent) {
            document.getElementById('progress').style.width = `${percent}%`;
        }
        
        // Close WebView
        function closeWebView() {
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.close();
            } else {
                window.close();
            }
        }
        
        // Contact support
        function contactSupport() {
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.openTelegramLink('https://t.me/TXG_MAKER_bot');
            } else {
                window.open('https://t.me/TXG_MAKER_bot', '_blank');
            }
        }
    </script>
</body>
  </html>
